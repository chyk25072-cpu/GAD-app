<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- „Éá„Ç∂„Ç§„É≥Â§âÊï∞ --- */
        :root {
            --bg-top: #e0fbfd;
            --bg-bottom: #fffcf0;
            --bg-friend-top: #fce4ec;
            --bg-friend-bottom: #fff0f5;
            --friend-btn-color: #ff80ab;
            --text-color: #333;
            --btn-green: #82c8bb;
            --btn-green-hover: #6fb3a6;
            --accent-green: #81c784;
            --line-color: #ccc;
            --line-height: 36px; 
            --font-size: 16px;
            --friend-tab-active-bg: #d81b60;
            --friend-tab-active-text: white;
        }

        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Arial, sans-serif;
            margin: 0; padding: 0; color: var(--text-color);
            height: 100vh; overflow: hidden; background-color: white;
        }

        .app-container {
            width: 100%; height: 100vh; display: flex; flex-direction: column; background-color: white;
        }

        /* --- PC„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú --- */
        @media (min-width: 768px) {
            .app-container { flex-direction: row; }
            .top-panel { width: 380px; height: 100%; overflow-y: auto; border-right: 1px solid #ddd; flex-shrink: 0; }
            .bottom-panel { flex: 1; height: 100%; overflow: hidden; }
        }
        @media (max-width: 767px) {
            .top-panel { flex-shrink: 0; }
            .bottom-panel { flex-grow: 1; }
        }

        /* --- Â∑¶(‰∏ä)„Éë„Éç„É´ --- */
        .top-panel {
            background-color: var(--bg-top); padding: 20px 25px 10px 25px; text-align: center;
            position: relative; box-sizing: border-box; transition: background-color 0.3s;
        }

        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .date-area { text-align: left; }
        .date-text { font-size: 1.4rem; font-weight: bold; color: #222; display: block; margin-bottom: 5px; }
        .calendar-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: #555; opacity: 0.7; padding: 0; }
        .calendar-btn:hover { opacity: 1; transform: scale(1.1); }

        .right-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .friend-toggle-btn {
            background-color: var(--btn-green); color: white; border: none; padding: 6px 15px; border-radius: 20px;
            font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .add-friend-icon-btn {
            background: none; border: none; cursor: pointer; color: var(--btn-green); font-size: 1.8rem; padding: 0; margin-right: 5px; transition: transform 0.2s;
        }
        .add-friend-icon-btn:hover { transform: scale(1.1); }

        /* ÂèãÈÅî„É™„Çπ„Éà */
        .friend-tabs-container { display: none; margin-bottom: 10px; text-align: left; }
        .friend-tabs-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; }
        .friend-tab {
            display: inline-block; padding: 5px 12px; border-radius: 15px; white-space: nowrap;
            background: rgba(255,255,255,0.6); border: 1px solid #ffc1e3; color: #d81b60;
            font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
        }
        .friend-tab.active { background: var(--friend-tab-active-bg); color: var(--friend-tab-active-text); border-color: var(--friend-tab-active-bg); }
        
        /* ÂèãÈÅîÊìç‰Ωú„Éú„Çø„É≥ */
        .friend-actions-row { display: none; justify-content: flex-end; gap: 10px; font-size: 0.75rem; margin-bottom: 10px; }
        .friend-action-link { background: none; border: none; cursor: pointer; color: #d81b60; text-decoration: underline; padding: 0; }

        h2.section-title { font-size: 0.8rem; color: #444; font-weight: bold; margin: 15px 0 10px 0; }

        .stamps { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; height: 50px; }
        .stamp-btn {
            background: none; border: none; padding: 0; width: 40px; height: 40px;
            cursor: pointer; opacity: 0.4; transition: all 0.2s; filter: grayscale(100%);
        }
        .stamp-btn img {
            width: 100%; height: 100%; object-fit: contain; pointer-events: none; mix-blend-mode: multiply;
        }
        .stamp-btn.active { opacity: 1; transform: scale(1.3); filter: grayscale(0%); }

        .task-container { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .task-list { list-style: none; padding: 0; margin: 0; width: 100%; max-width: 280px; text-align: left; }
        .task-item { display: flex; align-items: center; padding: 5px 0; font-size: 0.95rem; font-weight: bold; color: #333; }
        .custom-checkbox {
            width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%;
            margin-right: 10px; cursor: pointer; position: relative; flex-shrink: 0;
        }
        .custom-checkbox.checked { background-color: var(--btn-green); border-color: var(--btn-green); }
        .custom-checkbox.checked::after {
            content: '‚úî'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -52%); font-size: 12px;
        }
        .task-text { flex: 1; }
        .task-text.done { text-decoration: line-through; color: #999; }
        .delete-btn { background: none; border: none; color: #ccc; cursor: pointer; margin-left: 5px; }

        .add-task-row { display: flex; align-items: center; width: 100%; max-width: 280px; margin-top: 5px; color: #888; }
        .add-task-circle { width: 20px; height: 20px; border: 2px solid #ddd; border-radius: 50%; margin-right: 10px; }
        .add-task-input { border: none; background: transparent; font-size: 0.95rem; font-weight: bold; color: #555; outline: none; width: 100%; }
        .add-task-input::placeholder { color: #888; }

        /* --- Âè≥(‰∏ã)„Éë„Éç„É´ --- */
        .bottom-panel {
            background-color: var(--bg-bottom); display: flex; flex-direction: column; border-top: 1px solid #eee; transition: background-color 0.3s;
            @media (min-width: 768px) { border-top: none; border-left: 1px solid #eee; }
        }
        .diary-textarea {
            flex-grow: 1; width: 100%; box-sizing: border-box; border: none; background-color: var(--bg-bottom);
            resize: none; outline: none; font-size: var(--font-size); color: #555;
            line-height: var(--line-height);
            background-image: linear-gradient(transparent 96%, var(--line-color) 97%);
            background-size: 100% var(--line-height);
            background-attachment: local;
            padding: 0 40px; padding-top: 8px;
        }
        .diary-textarea::placeholder { color: #aaa; font-weight: bold; }

        /* --- ÂèãÈÅî„É¢„Éº„Éâ --- */
        body.friend-mode .top-panel { background-color: var(--bg-friend-top) !important; }
        body.friend-mode .bottom-panel { background-color: var(--bg-friend-bottom) !important; }
        body.friend-mode .diary-textarea { background-color: var(--bg-friend-bottom) !important; }
        
        body.friend-mode .friend-toggle-btn { background-color: var(--friend-btn-color); }
        body.friend-mode .add-task-row { display: none; }
        body.friend-mode .diary-textarea { pointer-events: none; }
        body.friend-mode .custom-checkbox { pointer-events: none; }
        
        body.friend-mode .friend-tabs-container { display: block; }
        body.friend-mode .friend-actions-row { display: flex; }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(2px); z-index: 1000; align-items: center; justify-content: center;
        }
        .friend-card {
            background: #fffcf5; width: 85%; max-width: 320px; border-radius: 15px; padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; position: relative;
        }
        .search-box {
            background: white; border-radius: 30px; display: flex; align-items: center; padding: 8px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .search-icon { color: #888; margin-right: 5px; }
        .import-input { border: none; outline: none; width: 100%; font-size: 0.9rem; }
        .my-code-area { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; font-weight: bold; color: #555; margin-top: 10px; }
        .code-display { background: white; padding: 5px 10px; border-radius: 5px; font-family: monospace; color: #333; margin-left: 10px; cursor: pointer; border: 1px dashed #ccc; }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5rem; color: #ccc; cursor: pointer; }

        .calendar-modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 350px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .cal-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 5px; cursor: pointer; position: relative; }
        .cal-day:hover { background: #f0f0f0; }
        .cal-day.today { border: 2px solid var(--btn-green); }
        .cal-day img { width: 60%; height: 60%; object-fit: contain; opacity: 0.8; }
        .cal-dot { width: 6px; height: 6px; background: #ccc; border-radius: 50%; }
        
        /* Êú™Êù•„ÅÆÊó•‰ªò„ÅÆ„Çπ„Çø„Ç§„É´ */
        .cal-day.future { background-color: #fcfcfc; color: #ddd; cursor: default; pointer-events: none; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000; }
        #hiddenCopyArea { position: absolute; left: -9999px; }

    </style>
</head>
<body>

    <div class="app-container">
        <div class="top-panel">
            
            <div class="header-row">
                <div class="date-area">
                    <span class="date-text" id="dateDisplay">Loading...</span>
                    <button class="calendar-btn" onclick="openCalendar()" title="„Ç´„É¨„É≥„ÉÄ„Éº">
                        <i class="fa-regular fa-calendar"></i> üìÖ
                    </button>
                </div>
                
                <div class="right-actions">
                    <button id="modeBtn" class="friend-toggle-btn" onclick="toggleMode()">
                        „Å®„ÇÇ„Å†„Å°„ÅÆÊó•Ë®ò
                    </button>
                    <button class="add-friend-icon-btn" onclick="openFriendModal()">
                        <i class="fa-solid fa-user-plus"></i> +
                    </button>
                </div>
            </div>

            <div class="friend-tabs-container">
                <div class="friend-tabs-scroll" id="friendListContainer"></div>
            </div>
            <div class="friend-actions-row" id="friendActions">
                <button class="friend-action-link" onclick="renameCurrentFriend()">ÂêçÂâç„ÇíÂ§âÊõ¥</button>
                <button class="friend-action-link" onclick="deleteCurrentFriend()" style="color:#aaa;">ÂâäÈô§</button>
            </div>

            <h2 class="section-title">‰ªäÊó•„ÅÆÊ∫ÄË∂≥Â∫¶</h2>
            <div class="stamps">
                <button class="stamp-btn" onclick="setMood(1)"><img src="./images/stamp1.png" alt="1"></button>
                <button class="stamp-btn" onclick="setMood(2)"><img src="./images/stamp2.png" alt="2"></button>
                <button class="stamp-btn" onclick="setMood(3)"><img src="./images/stamp3.png" alt="3"></button>
                <button class="stamp-btn" onclick="setMood(4)"><img src="./images/stamp4.png" alt="4"></button>
                <button class="stamp-btn" onclick="setMood(5)"><img src="./images/stamp5.png" alt="5"></button>
            </div>

            <h2 class="section-title">‰ªäÊó•„ÅÆ„Çø„Çπ„ÇØ</h2>
            <div class="task-container">
                <ul class="task-list" id="taskList"></ul>
                <div class="add-task-row">
                    <div class="add-task-circle"></div>
                    <input type="text" id="taskInput" class="add-task-input" placeholder="„Çø„Çπ„ÇØ„ÇíËøΩÂä†‚Ä¶">
                </div>
            </div>
        </div>

        <div class="bottom-panel">
            <textarea id="diaryInput" class="diary-textarea" placeholder="Êó•Ë®ò„ÇíÂÖ•Âäõ"></textarea>
        </div>
    </div>

    <div id="friendModal" class="modal-overlay">
        <div class="friend-card">
            <button class="close-modal-btn" onclick="closeModal('friendModal')">√ó</button>
            <h3>„Å®„ÇÇ„Å†„Å°ËøΩÂä†</h3>

            <div class="search-box">
                <span class="search-label">„Å®„ÇÇ„Å†„Å°„ÇíÊé¢„Åô</span>
                <span class="search-icon">üîç</span>
                <input type="text" id="importInput" class="import-input" placeholder="„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë">
            </div>
            <button onclick="executeImport()" style="background:var(--btn-green); color:white; border:none; padding:5px 15px; border-radius:15px; cursor:pointer; font-size:0.8rem; margin-bottom:15px;">ËøΩÂä†„Åô„Çã</button>

            <div class="my-code-area">
                <span>„ÅÇ„Å™„Åü„ÅÆ„Å®„ÇÇ„Å†„Å°„Ç≥„Éº„Éâ</span>
                <span class="code-display" onclick="copyMyCode()" title="„Çø„ÉÉ„Éó„Åó„Å¶„Ç≥„Éî„Éº">
                    „Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº
                </span>
            </div>
            <p style="font-size:0.7rem; color:#999; margin-top:5px;">‚Äª„Çø„ÉÉ„Éó„Åô„Çã„Å®ÂÖ®„Éá„Éº„Çø„Åå„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åô</p>
        </div>
    </div>

    <div id="calendarModal" class="modal-overlay">
        <div class="calendar-modal-content">
            <div class="cal-header">
                <span onclick="changeMonth(-1)" style="cursor:pointer">‚óÄ</span>
                <span id="calMonthLabel"></span>
                <span onclick="changeMonth(1)" style="cursor:pointer">‚ñ∂</span>
            </div>
            <div class="cal-grid" id="calendarGrid"></div>
            <div style="text-align:center; margin-top:15px;">
                <button onclick="closeModal('calendarModal')" style="background:#eee; border:none; padding:8px 20px; border-radius:20px;">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">‰øùÂ≠ò„Åó„Åæ„Åó„Åü</div>
    <textarea id="hiddenCopyArea"></textarea>

    <script>
        // --- „Éá„Éº„ÇøÁÆ°ÁêÜ ---
        let myHistory = {};
        let friendList = [];
        let isFriendMode = false;
        let currentFriendIndex = -1;
        
        let currentTasks = [];
        let viewingDate = new Date();
        let calYear = viewingDate.getFullYear();
        let calMonth = viewingDate.getMonth();
        
        const STAMP_ICONS = ["", 
            "./images/stamp1.png", "./images/stamp2.png", "./images/stamp3.png", "./images/stamp4.png", "./images/stamp5.png"
        ];

        const STORAGE_KEY_MY = 'gad_history_v1';
        const STORAGE_KEY_FRIEND = 'gad_friend_list_v2'; 

        window.onload = function() {
            if(localStorage.getItem(STORAGE_KEY_MY)) myHistory = JSON.parse(localStorage.getItem(STORAGE_KEY_MY));
            if(localStorage.getItem(STORAGE_KEY_FRIEND)) friendList = JSON.parse(localStorage.getItem(STORAGE_KEY_FRIEND));

            // ‚òÖËµ∑ÂãïÊôÇ„ÉÅ„Çß„ÉÉ„ÇØ: Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅÆÁπ∞„ÇäË∂ä„Åó („É≠„Éº„É´„Ç™„Éº„Éê„Éº)
            checkTaskRollover();

            loadDate(new Date());

            document.getElementById('taskInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addTask();
            });
            document.getElementById('diaryInput').addEventListener('input', debounce(() => {
                if(!isFriendMode) saveCurrentDate();
            }, 1000));
        };

        // --- „É≠„Ç∏„ÉÉ„ÇØ ---
        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // ‚òÖÊú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅÆËá™ÂãïÁπ∞„ÇäË∂ä„ÅóÊ©üËÉΩ
        function checkTaskRollover() {
            const todayKey = formatDateKey(new Date());
            
            // „Åô„Åß„Å´‰ªäÊó•„ÅÆ„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà‰∏ÄÂõû„Å†„ÅëÂÆüË°åÔºâ
            if (myHistory[todayKey]) return;

            // ÈÅéÂéª„ÅÆ„Éá„Éº„Çø„ÇíÊé¢„Åô
            const keys = Object.keys(myHistory).sort();
            if (keys.length === 0) return;

            // ÊúÄÊñ∞„ÅÆÈÅéÂéª„Éá„Éº„Çø
            const lastKey = keys[keys.length - 1];
            // Âøµ„ÅÆ„Åü„ÇÅ„ÄÅÈÅéÂéª„ÅÆÊó•‰ªò„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
            if (new Date(lastKey) >= new Date(todayKey)) return;

            const lastData = myHistory[lastKey];
            if (!lastData || !lastData.tasks) return;

            // Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÇíÊäΩÂá∫
            const unfinished = lastData.tasks.filter(t => !t.done);

            if (unfinished.length > 0) {
                // ‰ªäÊó•„ÅÆ„Éá„Éº„Çø„Å®„Åó„Å¶‰øùÂ≠òÔºàID„ÅØÁ´∂Âêà„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´ÂÜçÁîüÊàêÔºâ
                myHistory[todayKey] = {
                    tasks: unfinished.map(t => ({...t, id: Date.now() + Math.random()})), 
                    diary: "", // Êó•Ë®ò„ÅØÁ©∫
                    mood: 0,
                    timestamp: Date.now()
                };
                localStorage.setItem(STORAGE_KEY_MY, JSON.stringify(myHistory));
                // ‚Äª„Åì„ÅÆÂæå loadDate() „ÅåÂëº„Å∞„Çå„Çã„ÅÆ„ÅßÁîªÈù¢„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô
            }
        }

        function loadDate(date) {
            viewingDate = date;
            
            const y = viewingDate.getFullYear();
            const m = viewingDate.getMonth() + 1;
            const d = viewingDate.getDate();
            document.getElementById('dateDisplay').innerText = `${y}/${m.toString().padStart(2,'0')}/${d.toString().padStart(2,'0')}`;

            let data = {};
            if(isFriendMode) {
                if(currentFriendIndex !== -1 && friendList[currentFriendIndex]) {
                    data = friendList[currentFriendIndex].data[formatDateKey(date)] || {};
                }
            } else {
                data = myHistory[formatDateKey(date)] || {};
            }

            currentTasks = JSON.parse(JSON.stringify(data.tasks || []));
            renderTasks();
            document.getElementById('diaryInput').value = data.diary || "";
            updateMoodVisuals(data.mood || 0);
        }

        function saveCurrentDate() {
            if(isFriendMode) return;
            const key = formatDateKey(viewingDate);
            myHistory[key] = {
                tasks: currentTasks,
                diary: document.getElementById('diaryInput').value,
                mood: getCurrentMood(),
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY_MY, JSON.stringify(myHistory));
        }

        function saveFriendList() {
            localStorage.setItem(STORAGE_KEY_FRIEND, JSON.stringify(friendList));
        }

        function renderFriendTabs() {
            const container = document.getElementById('friendListContainer');
            container.innerHTML = '';
            
            if(friendList.length === 0) {
                container.innerHTML = '<span style="font-size:0.8rem; color:#888;">„Åæ„Å†ÂèãÈÅî„Åå„ÅÑ„Åæ„Åõ„Çì</span>';
                document.getElementById('friendActions').style.display = 'none';
                return;
            }

            document.getElementById('friendActions').style.display = 'flex';

            friendList.forEach((friend, idx) => {
                const tab = document.createElement('div');
                tab.className = `friend-tab ${idx === currentFriendIndex ? 'active' : ''}`;
                tab.innerText = friend.name;
                tab.onclick = () => selectFriend(idx);
                container.appendChild(tab);
            });
        }

        function selectFriend(idx) {
            currentFriendIndex = idx;
            renderFriendTabs();
            loadDate(viewingDate);
        }

        function renameCurrentFriend() {
            if(currentFriendIndex === -1 || !friendList[currentFriendIndex]) return;
            const newName = prompt("Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ:", friendList[currentFriendIndex].name);
            if(newName && newName.trim()) {
                friendList[currentFriendIndex].name = newName.trim();
                saveFriendList();
                renderFriendTabs();
            }
        }

        function deleteCurrentFriend() {
            if(currentFriendIndex === -1 || !friendList[currentFriendIndex]) return;
            if(confirm(`„Äå${friendList[currentFriendIndex].name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`)) {
                friendList.splice(currentFriendIndex, 1);
                if(friendList.length === 0) currentFriendIndex = -1;
                else if(currentFriendIndex >= friendList.length) currentFriendIndex = friendList.length - 1;
                
                saveFriendList();
                renderFriendTabs();
                loadDate(viewingDate);
            }
        }

        function toggleMode() {
            isFriendMode = !isFriendMode;
            const btn = document.getElementById('modeBtn');
            
            if(isFriendMode) {
                document.body.classList.add('friend-mode');
                btn.innerText = "Ëá™ÂàÜ„ÅÆÊó•Ë®ò„Å´Êàª„Çã";
                btn.classList.add('active');
                
                renderFriendTabs();
                if(friendList.length > 0 && currentFriendIndex === -1) currentFriendIndex = 0;
                else if(friendList.length === 0) currentFriendIndex = -1;
                
            } else {
                document.body.classList.remove('friend-mode');
                btn.innerText = "„Å®„ÇÇ„Å†„Å°„ÅÆÊó•Ë®ò";
                btn.classList.remove('active');
                
                document.getElementById('friendActions').style.display = 'none';
            }
            loadDate(viewingDate);
        }

        function addTask() {
            if(isFriendMode) return;
            const val = document.getElementById('taskInput').value.trim();
            if(!val) return;
            currentTasks.push({ id: Date.now(), text: val, done: false });
            document.getElementById('taskInput').value = '';
            renderTasks();
            saveCurrentDate();
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            currentTasks.forEach(t => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.innerHTML = `
                    <div class="custom-checkbox ${t.done ? 'checked' : ''}" onclick="toggleTask(${t.id})"></div>
                    <span class="task-text ${t.done ? 'done' : ''}">${escapeHtml(t.text)}</span>
                    <button class="delete-btn" onclick="deleteTask(${t.id})">√ó</button>
                `;
                list.appendChild(li);
            });
        }

        function toggleTask(id) {
            if(isFriendMode) return;
            const t = currentTasks.find(x => x.id === id);
            if(t) {
                if(!t.done) {
                    const diary = document.getElementById('diaryInput');
                    diary.value += (diary.value ? " " : "") + t.text;
                }
                t.done = !t.done;
                renderTasks();
                saveCurrentDate();
            }
        }

        function deleteTask(id) {
            if(isFriendMode) return;
            if(confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                currentTasks = currentTasks.filter(x => x.id !== id);
                renderTasks();
                saveCurrentDate();
            }
        }

        function setMood(level) {
            if(isFriendMode) return;
            updateMoodVisuals(level);
            saveCurrentDate();
        }
        function updateMoodVisuals(level) {
            document.querySelectorAll('.stamp-btn').forEach((btn, idx) => {
                if(idx + 1 === level) btn.classList.add('active');
                else btn.classList.remove('active');
            });
        }
        function getCurrentMood() {
            const active = document.querySelector('.stamp-btn.active');
            if(!active) return 0;
            return Array.from(document.querySelectorAll('.stamp-btn')).indexOf(active) + 1;
        }

        function openFriendModal() { document.getElementById('friendModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function copyMyCode() {
            const json = JSON.stringify(myHistory);
            const code = utf8_to_b64(json);
            const area = document.getElementById('hiddenCopyArea');
            area.value = code;
            area.select();
            document.execCommand('copy');
            showToast("„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
        }

        function executeImport() {
            const code = document.getElementById('importInput').value.trim();
            if(!code) return;
            try {
                const data = JSON.parse(b64_to_utf8(code));
                
                const name = `„Å®„ÇÇ„Å†„Å°${friendList.length + 1}`;
                friendList.push({ name: name, data: data });
                saveFriendList();
                
                showToast(`${name} „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
                document.getElementById('importInput').value = '';
                closeModal('friendModal');

                if(!isFriendMode) toggleMode();
                selectFriend(friendList.length - 1);

            } catch(e) {
                alert('„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
            }
        }

        function openCalendar() {
            document.getElementById('calendarModal').style.display = 'flex';
            renderCalendar();
        }
        function changeMonth(d) {
            calMonth += d;
            if(calMonth > 11) { calMonth = 0; calYear++; }
            if(calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar();
        }
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('calMonthLabel').innerText = `${calYear}Âπ¥ ${calMonth+1}Êúà`;
            
            let history = isFriendMode ? (friendList[currentFriendIndex]?.data || {}) : myHistory;

            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const lastDate = new Date(calYear, calMonth+1, 0).getDate();
            
            // ‚òÖ‰ªäÊó•„ÅÆÊØîËºÉÁî®Ôºà0ÊôÇ0ÂàÜ0Áßí„Å´„É™„Çª„ÉÉ„ÉàÔºâ
            const today = new Date();
            today.setHours(0,0,0,0);

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=lastDate; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                
                const currentDate = new Date(calYear, calMonth, d);
                const key = formatDateKey(currentDate);
                
                // ‚òÖÊú™Êù•„ÅÆÊó•‰ªò„ÉÅ„Çß„ÉÉ„ÇØ
                if (currentDate > today) {
                    cell.classList.add('future');
                    cell.innerText = d;
                    // onclick„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö„Åó„Å™„ÅÑ„Åì„Å®„Åß„ÇØ„É™„ÉÉ„ÇØ‰∏çÂèØ„Å´
                } else {
                    // ÈÄöÂ∏∏„ÅÆÊó•‰ªòÔºà‰ªäÊó•„ÇíÂê´„ÇÄÈÅéÂéªÔºâ
                    if(key === formatDateKey(today)) cell.classList.add('today');
                    
                    if(history[key] && history[key].mood > 0) {
                        const img = document.createElement('img');
                        img.src = STAMP_ICONS[history[key].mood];
                        cell.appendChild(img);
                    } else {
                        cell.innerText = d;
                        if(history[key] && (history[key].diary || (history[key].tasks && history[key].tasks.length))) {
                            const dot = document.createElement('div');
                            dot.className = 'cal-dot';
                            dot.style.position = 'absolute'; dot.style.bottom='5px';
                            cell.appendChild(dot);
                        }
                    }
                    
                    cell.onclick = () => {
                        loadDate(new Date(calYear, calMonth, d));
                        closeModal('calendarModal');
                    };
                }
                
                grid.appendChild(cell);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }
        function escapeHtml(str) { return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

    </script>
</body>
</html>
